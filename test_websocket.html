<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Test - GeoDjango</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        #messages { border: 1px solid #ccc; height: 300px; overflow-y: scroll; padding: 10px; margin: 20px 0; }
        .message { margin: 5px 0; padding: 5px; }
        .sent { background-color: #e3f2fd; }
        .received { background-color: #f1f8e9; }
        .error { background-color: #ffebee; color: #c62828; }
        .success { background-color: #e8f5e9; color: #2e7d32; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        input { padding: 10px; width: 300px; }
    </style>
</head>
<body>
    <h1>üåê GeoDjango WebSocket Test</h1>
    
    <div>
        <h3>Connection Status: <span id="status">Disconnected</span></h3>
        <button onclick="connect()">Connect</button>
        <button onclick="disconnect()">Disconnect</button>
    </div>

    <div>
        <h3>Test Actions:</h3>
        <button onclick="sendPing()">Send Ping</button>
        <button onclick="getNearbyPlaces()">Get Nearby Places (AZ)</button>
        <button onclick="testEcho()">Test Echo</button>
    </div>

    <div>
        <h3>Custom Message:</h3>
        <input type="text" id="customMessage" placeholder="Enter JSON message">
        <button onclick="sendCustom()">Send</button>
    </div>

    <div id="messages"></div>

    <script>
        let ws1 = null;  // location_updates
        let ws2 = null;  // live

        function log(message, className = '') {
            const div = document.createElement('div');
            div.className = 'message ' + className;
            div.textContent = new Date().toLocaleTimeString() + ' - ' + message;
            document.getElementById('messages').appendChild(div);
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
        }

        function connect() {
            // Connect to location updates
            ws1 = new WebSocket('ws://localhost:8000/ws/locations/updates/');
            
            ws1.onopen = function(e) {
                document.getElementById('status').textContent = 'Connected';
                document.getElementById('status').style.color = 'green';
                log('‚úÖ Connected to location updates WebSocket', 'success');
            };

            ws1.onmessage = function(event) {
                log('‚¨á Received: ' + event.data, 'received');
            };

            ws1.onerror = function(error) {
                log('‚ùå WebSocket Error: ' + error, 'error');
            };

            ws1.onclose = function(event) {
                document.getElementById('status').textContent = 'Disconnected';
                document.getElementById('status').style.color = 'red';
                log('Connection closed', '');
            };

            // Also connect to live WebSocket
            ws2 = new WebSocket('ws://localhost:8000/ws/locations/live/');
            
            ws2.onopen = function(e) {
                log('‚úÖ Connected to live WebSocket', 'success');
            };

            ws2.onmessage = function(event) {
                log('‚¨á Live: ' + event.data, 'received');
            };
        }

        function disconnect() {
            if (ws1) ws1.close();
            if (ws2) ws2.close();
        }

        function sendPing() {
            if (!ws1 || ws1.readyState !== WebSocket.OPEN) {
                log('‚ùå Not connected. Click Connect first.', 'error');
                return;
            }
            const message = JSON.stringify({ action: 'ping' });
            ws1.send(message);
            log('‚¨Ü Sent: ' + message, 'sent');
        }

        function getNearbyPlaces() {
            if (!ws1 || ws1.readyState !== WebSocket.OPEN) {
                log('‚ùå Not connected. Click Connect first.', 'error');
                return;
            }
            const message = JSON.stringify({
                action: 'get_places',
                lat: 33.4484,  // Phoenix, AZ
                lon: -112.0740,
                radius: 10000  // 10km
            });
            ws1.send(message);
            log('‚¨Ü Sent get_places request', 'sent');
        }

        function testEcho() {
            if (!ws2 || ws2.readyState !== WebSocket.OPEN) {
                log('‚ùå Not connected. Click Connect first.', 'error');
                return;
            }
            const message = JSON.stringify({ test: 'echo', message: 'Hello from client!' });
            ws2.send(message);
            log('‚¨Ü Sent to echo WebSocket: ' + message, 'sent');
        }

        function sendCustom() {
            if (!ws1 || ws1.readyState !== WebSocket.OPEN) {
                log('‚ùå Not connected. Click Connect first.', 'error');
                return;
            }
            const input = document.getElementById('customMessage').value;
            try {
                JSON.parse(input);  // Validate JSON
                ws1.send(input);
                log('‚¨Ü Sent: ' + input, 'sent');
            } catch (e) {
                log('‚ùå Invalid JSON: ' + e.message, 'error');
            }
        }
    </script>
</body>
</html>

